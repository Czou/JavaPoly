<html>
<head>
  <meta charset="utf-8">
  <title>Mocha Tests</title>
  <link href="mocha/mocha.css" rel="stylesheet" />

  <script type="text/javascript" src="mocha/browserfs.min.js"></script>
  <script type="text/javascript" src="doppio/doppio.js"></script>

  <script type="text/javascript" src="build/javapoly.js"></script>

  <script type="application/java-vm" src="classes/Main.class"></script>
  <script type="application/java-vm" src="classes/MainWithPackage.class"></script>
  <script type="application/java-archive" src="jars/javapoly-utils.jar"></script>
</head>
<body>
  <div id="mocha"></div>

  <script src="mocha/expect.js"></script>
  <script src="mocha/mocha.js"></script>

  <script type="text/javascript">
    mocha.setup('bdd');

    describe('JVMReady', function() {
      it('load jvm', function() {
        expect(J).to.exist;
        expect(Java).to.exist;
      });

      describe('Proxy access', function() {
        describe('java.lang.Integer', function() {
          it('toHexString', function() {
            J.java.lang.Integer.toHexString(42).then(function(result) {
              expect(result).to.eql('2a');
              console.log('+');
            });
          });

          it('reverse', function() {
            J.java.lang.Integer.reverse(42).then(function(result) {
              expect(result).to.eql(1409286144);
              console.log('+');
            });
          });

          it('toString', function() {
            J.java.lang.Integer.toString(42, 16).then(function(result) {
              expect(result).to.eql('2a');
              console.log('+');
            });
          });

          it('compare', function() {
            J.java.lang.Integer.compare(42, 41).then(function(result) {
              expect(result).to.eql(1);
              console.log('+');
            });
          });
        });

        describe('java.lang.Double', function() {
          it('toHexString', function() {
            J.java.lang.Double.toHexString(42).then(function(result) {
              expect(result).to.eql('0x1.5p5');
              console.log('+');
            });
          });
        });

        describe('classes/Main.class', function() {
          it('static test()', function() {
            J.Main.test().then(function(result) {
              expect(result).to.eql('test message');
              console.log('+');
            });
          })
        });

        describe('jars/javapoly-utils.jar', function() {
          it('jar static test()', function() {
            J.com.javapoly.utils.Test.test().then(function(result) {
              expect(result).to.eql('test message in jar');
              console.log('+');
            });
          })
        });

      });

      describe('String identifiers access', function() {
        describe('java.lang.Integer', function() {
          it('calls methods', function() {
            Java.type('java.lang.Integer').then(function(Integer) {
              Integer.toHexString(42).then(function(result) {
                expect(result).to.eql('2a');
                console.log('+');
              });
              Integer.toString(42, 16).then(function(result) {
                expect(result).to.eql('2a');
                console.log('+');
              });
            });
          });
        });
      });
    });

    // FIXME: now it is required to put '+' to make sure we have executed all tests
    // fix it with proper Promises tests

    mocha.checkLeaks();
    mocha.run();
  </script>
</body>
</html>
