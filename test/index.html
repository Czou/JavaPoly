<html>
<head>
  <meta charset="utf-8">
  <title>Mocha Tests</title>
  <link href="mocha/mocha.css" rel="stylesheet" />

  <script type="text/javascript" src="build/javapoly.js"></script>

  <script type="application/java-vm" src="classes/Main.class"></script>
  <script type="application/java-vm" src="classes/MainWithPackage.class"></script>
  <script type="application/java-vm" src="classes/Utilities.class"></script>
  <script type="application/java-archive" src="jars/javapoly-utils.jar"></script>
</head>
<body>
  <div id="mocha"></div>

  <script src="expect/umd/expect.min.js"></script>
  <script src="mocha/mocha.js"></script>

  <script type="text/javascript">
    mocha.setup('bdd');
    expect.extend({
      toBeGreaterThanOrEqual(limit) {
        expect.assert(this.actual >= limit, 'expected %s to be greater than or equal to ' + limit, this.actual);
      }
    });

    describe('JavaPoly', function() {
      this.timeout(1000000); // Let jvm to start and do not interrupt promises

      var isProxySupported = (typeof Proxy !== 'undefined');

      describe('Proxy access', function() {

        if (!isProxySupported) {

          it('checks that J is undefined if Proxy is not supported', function() {
            expect(typeof J === 'undefined').toBe(true);
          });

        } else {

          it('checks that J is defined', function() {
            expect(J).toExist();
          });

          describe('java.lang.Integer', function() {

            it('toHexString', function() {
              return J.java.lang.Integer.toHexString(42).then(function(result) {
                expect(result).toEqual('2a');
              });
            });

            it('reverse', function() {
              return J.java.lang.Integer.reverse(42).then(function(result) {
                expect(result).toEqual(1409286144);
              });
            });

            it('compare', function() {
              return J.java.lang.Integer.compare(42, 41).then(function(result) {
                expect(result).toEqual(1);
              });
            });

            it('parseInt', function() {
              return J.java.lang.Integer.parseInt('42').then(function(result) {
                expect(result).toEqual(42);
              });
            });

          });

          describe('java.lang.Double', function() {
            it('toHexString', function() {
              return J.java.lang.Double.toHexString(42).then(function(result) {
                expect(result).toEqual('0x1.5p5');
              });
            });
          });

          describe('classes/Main.class', function() {
            it('static test()', function() {
              return J.Main.test().then(function(result) {
                expect(result).toEqual('test message');
              });
            })
          });

          describe('jars/javapoly-utils.jar', function() {
            it('jar static test()', function() {
              return J.com.javapoly.utils.Test.test().then(function(result) {
                expect(result).toEqual('test message in jar');
              });
            })
          });

        }
      });

      /* Disabling for now. We can re-enable after using the newer version of eval.

      describe('Utilities', function() {

        describe('eval', function() {
          it('integer arithmetic', function() {
            return Java.type('com.javapoly.runtime.Utilities').then(function(Utilities) {
              Utilities.eval("40 + 2").then(function(result) {
                expect(result).toEqual(42);
              });
            });
          });

          it('string split', function() {
            return Java.type('com.javapoly.runtime.Utilities').then(function(Utilities) {
              Utilities.eval("'a,b,c'.split(',')").then(function(result) {
                expect(result).toEqual(["a", "b", "c"]);
              });
            });
          });

          it('function definition', function() {
            return Java.type('com.javapoly.runtime.Utilities').then(function(Utilities) {
              Utilities.eval("(function(x){return x*x})").then(function(result) {
                expect(result(7)).toEqual(49);
              });
            });
          });

        });

      });
      */

      describe('String identifiers access', function() {

        it('checks that Java is defined', function() {
          expect(Java).toExist();
          expect(Java.type).toExist();
        });

        describe('Java.type', function() {

          it('should load class', function() {
            return Java.type('java.lang.Integer').then(function(Integer) {
              expect(Integer).toExist();
            });
          });

          describe('java.lang.Integer', function() {
            it('toHexString', function() {
              return Java.type('java.lang.Integer').then(function(Integer) {
                return Integer.toHexString(42).then(function(result) {
                  expect(result).toEqual('2a');
                });
              });
            });
            it('toString', function() {
              return Java.type('java.lang.Integer').then(function(Integer) {
                return Integer.toString(42, 16).then(function(result) {
                  expect(result).toEqual('2a');
                });
              });
            });
          });

        });

        describe('Math', function() {
          it('addExact() should add', function() {
            return Java.type('java.lang.Math').then(function(Math) {
              return Math.addExact(3, 7).then(function(result) {
                expect(result).toEqual(10);
              });
            });
          });

          it('random() should return a value', function() {
            return Java.type('java.lang.Math').then(function(Math) {
              return Math.random().then(function(result) {
                expect(result)
                  .toExist()
                  .toBeLessThan(1.0)
                  .toBeGreaterThanOrEqual(0);
              });
            });
          })
        });

        describe('System', function() {
          it('currentTimeMillis() should return a timestamp', function() {
            return Java.type('java.lang.System').then(function(System) {
              return System.currentTimeMillis().then(function(result) {
                expect(result)
                  .toExist()
                  .toBeGreaterThanOrEqual(0);
              });
            });
          });
        });

        describe('classes/Main.class', function() {
          it('static test()', function() {
            return Java.type('Main').then(function(Main) {
              return Main.test().then(function(result) {
                expect(result).toEqual('test message');
              });
            });
          })
        });

      });

    });

    // TODO: akadeev: checkLeaks() does not work for such complex promises tests
    // There might be a way to fix it
    //mocha.checkLeaks();
    mocha.run();
  </script>
</body>
</html>
