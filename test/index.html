<html>
<head>
  <meta charset="utf-8">
  <title>JavaPoly Tests</title>
  <link href="mocha/mocha.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet" />

  <script type="text/javascript" src="build/javapoly.js"></script>

  <script type="application/java-vm" src="classes/Main.class"></script>
  <script type="application/java-vm" src="classes/EvalTest.class"></script>
  <script type="application/java-vm" src="classes/Counter.class"></script>
  <script type="application/java-vm" src="classes/com/javapoly/MainWithPackage.class"></script>
  <script type="application/java-archive" src="jars/javapoly-utils.jar"></script>

</head>
<body>
  <ul class="workerChoice">
    <li class="browser"><a href='/'>Browser version</a></li>
    <li class="worker"><a href='/?worker=build/javapoly_worker.js'>Web worker version</a></li>
  </ul>

  <div id="mocha"></div>

  <script src="expect/umd/expect.min.js"></script>
  <script src="mocha/mocha.js"></script>

  <script type="text/javascript">
    mocha.setup('bdd');

    expect.extend({
      toBeGreaterThanOrEqual(limit) {
        expect.assert(this.actual >= limit, 'expected %s to be greater than or equal to ' + limit, this.actual);
        return this;
      },
      toStartWith(prefix) {
        expect.assert(this.actual.startsWith(prefix), 'expected %s to start with ' + prefix, this.actual);
        return this;
      },
      toEndWith(suffix) {
        expect.assert(this.actual.endsWith(suffix), 'expected %s to end with ' + suffix, this.actual);
        return this;
      },
      toNeverReachHere() {
        expect.assert(false, 'never expected to reach here');
        return this;
      }
    });

    var isWorkerBased = !!defaultJavapoly.options.worker;
    document.querySelector(".workerChoice " + (isWorkerBased ? ".worker" : ".browser")).classList.add("selected");

    var titleSuffix = isWorkerBased ? " Web Worker" : " Browser";

    describe('JavaPoly' + titleSuffix, function() {
      this.timeout(100000); // Let jvm to start and do not interrupt promises

      var isProxySupported = (typeof Proxy !== 'undefined');

      describe('Proxy access', function() {

        if (!isProxySupported) {

          it('checks that J is undefined if Proxy is not supported', function() {
            expect(typeof J === 'undefined').toBe(true);
          });

        } else {

          it('checks that J is defined', function() {
            expect(J).toExist();
          });

          describe('java.lang.Integer', function() {

            it('toHexString', function() {
              return J.java.lang.Integer.toHexString(42).then(function(result) {
                expect(result).toEqual('2a');
              });
            });

            it('reverse', function() {
              return J.java.lang.Integer.reverse(42).then(function(result) {
                expect(result).toEqual(1409286144);
              });
            });

            it('compare', function() {
              return J.java.lang.Integer.compare(42, 41).then(function(result) {
                expect(result).toEqual(1);
              });
            });

            it('parseInt', function() {
              return J.java.lang.Integer.parseInt('42').then(function(result) {
                expect(result).toEqual(42);
              });
            });

          });

          describe('java.lang.Double', function() {
            it('toHexString', function() {
              return J.java.lang.Double.toHexString(42).then(function(result) {
                expect(result).toEqual('0x1.5p5');
              });
            });
          });

          describe('classes/Main.class', function() {
            it('static test()', function() {
              return J.Main.test().then(function(result) {
                expect(result).toEqual('test message');
              });
            })
          });

          describe('jars/javapoly-utils.jar', function() {
            it('jar static test()', function() {
              return J.com.javapoly.utils.Test.test().then(function(result) {
                expect(result).toEqual('test message in jar');
              });
            })
          });

        }
      });

      if (!isWorkerBased) {
        // Object wrappers are not supported in web-worker mode

        describe('Object wrappers', function() {

          it('should wrap fields', function() {
            return Java.new('Counter').then(function(counter) {
              var t1 = counter.increment(42).then(function() {
                return counter.currentValue.then(function(cValue) {
                  expect(cValue).toEqual(15);
                });
              });
              return t1.then(function() {
                counter.currentValue = 42;
                return counter.isValid().then(function(itIsValid) {
                  expect(itIsValid).toBe(false);
                });
              });
            });
          });

          it('should automatically unwrap when passed as parameter', function() {
            return Java.new("java.io.File", "/abc").then(function(abcFile) {
              return Java.new("java.io.File", "/xyz").then(function(xyzFile) {
                return abcFile.compareTo(xyzFile).then(function(comparison) {
                  expect(comparison).toBeLessThan(0);
                });
              });
            });
          });

          it('should be used for new objects defined with convenience function', function() {
            return Java.new('java.io.File', "/sys/someunlikelyfilenamethatwontexist").then(function(file) {
              return file.exists().then(function(itExists) {
                expect(itExists).toBe(false);
              });
            });
          });

          it('should be used for new objects', function() {
            return Java.type('java.io.File').then(function(File) {
              return new File("/sys/someunlikelyfilenamethatwontexist").then(function(file) {
                return file.exists().then(function(itExists) {
                  expect(itExists).toBe(false);
                });
              });
            });
          });

          describe('should wrap Properties object', function() {
            it('get property', function() {
              return Java.type('java.lang.System').then(function(System) {
                return System.getProperties().then(function(properties) {

                  function checkProperty(key, expectedValue) {
                    return properties.getProperty(key).then(function(value) {
                      expect(value).toEqual(expectedValue);
                    });
                  }

                  return Promise.all([
                    checkProperty("os.arch", "js"),
                    checkProperty("user.name", "DoppioUser"),
                    checkProperty("java.io.tmpdir", "/tmp"),
                    checkProperty("java.vm.vendor", "PLASMA@UMass"),
                    checkProperty("java.vm.name", "DoppioJVM 32-bit VM"),
                    checkProperty("java.awt.headless", "true")
                  ]);
                });
              });
            });
          });

        });

      }

      describe('Eval', function() {

        it('should pass all tests from EvalTest.java', function() {
          return Java.type('EvalTest').then(function(EvalTest) {
            return EvalTest.test().then(function(result) {
              expect(result).toEqual(true);
            });
          });
        });

        if (!isWorkerBased) {
          it('should reflect js object into java', function() {
            return Java.type("EvalTest").then(function(EvalTest) {
              var stringTest = EvalTest.getProperty({name1: "xyz", name2: 10}, "name1").then(function(name1Val) {
                expect(name1Val).toBe("xyz");
              });
              var numberTest = EvalTest.getProperty({name1: "xyz", name2: 10}, "name2").then(function(name2Val) {
                expect(name2Val).toBe(10);
              });
              var deepObjTest = EvalTest.getProperty({name1: "xyz", name3: {inner:"pqr"}}, "name3").then(function(name3Val) {
                expect(name3Val.inner).toBe("pqr");
              });
              return Promise.all([stringTest, numberTest, deepObjTest]);
            });
          });

          it('should reflect js object from java', function() {
            return Java.type("com.javapoly.Eval").then(function(Eval) {
              return Eval.eval('({name1: "xyz", name2: 10, name3: {inner: "music"}})').then(function(result) {
                expect(result.name1).toBe("xyz");
                expect(result.name3.inner).toBe("music");
              });
            });
          });
        }
      });

      /* Disabling for now. We can re-enable after using the newer version of eval.

      describe('Utilities', function() {

        describe('eval', function() {
          it('integer arithmetic', function() {
            return Java.type('com.javapoly.runtime.Utilities').then(function(Utilities) {
              Utilities.eval("40 + 2").then(function(result) {
                expect(result).toEqual(42);
              });
            });
          });

          it('string split', function() {
            return Java.type('com.javapoly.runtime.Utilities').then(function(Utilities) {
              Utilities.eval("'a,b,c'.split(',')").then(function(result) {
                expect(result).toEqual(["a", "b", "c"]);
              });
            });
          });

          it('function definition', function() {
            return Java.type('com.javapoly.runtime.Utilities').then(function(Utilities) {
              Utilities.eval("(function(x){return x*x})").then(function(result) {
                expect(result(7)).toEqual(49);
              });
            });
          });

        });

      });
      */

      describe('String identifiers access', function() {

        it('checks that Java is defined', function() {
          expect(Java).toExist();
          expect(Java.type).toExist();
        });

        if (!isWorkerBased) {
          // Doppio not available when using web worker
          it('doppio should not be a release build', function() {
            Java.type('java.lang.Integer').then(function() {
              expect(Doppio.VM.JVM.isReleaseBuild()).toBe(false);
            });
          });
        }

        describe('Java.type', function() {

          it('should load class', function() {
            return Java.type('java.lang.Integer').then(function(Integer) {
              expect(Integer).toExist();
            });
          });

          it('should handle exceptions correctly', function() {
            return Java.type('Main').then(function(Main) {
              return new Promise(function(resolve, reject) {
                Main.exceptionThrower().then(function() {
                  reject(new Error("not expecting the promise to resolve"));
                }, function(e) {
                  expect(e.name).toBe("java.lang.RuntimeException");
                  expect(e.message).toBe("Deliberate exception for testing");
                  expect(e.causedBy).toNotExist();
                  expect(e.printStackTrace).toExist();
                  resolve();
                });
              });
            });
          });

          describe('java.lang.Integer', function() {
            it('instance method should not exist in class wrapper: byteValue', function() {
              return Java.type('java.lang.Integer').then(function(Integer) {
                expect(Integer.byteValue).toNotExist();
              });
            });

            it('toHexString', function() {
              return Java.type('java.lang.Integer').then(function(Integer) {
                return Integer.toHexString(42).then(function(result) {
                  expect(result).toEqual('2a');
                });
              });
            });

            it('toString', function() {
              return Java.type('java.lang.Integer').then(function(Integer) {
                return Integer.toString(42, 16).then(function(result) {
                  expect(result).toEqual('2a');
                });
              });
            });

            it('parseInt', function() {
              return Java.type('java.lang.Integer').then(function(Integer) {
                return Integer.parseInt('42').then(function(result) {
                  expect(result).toEqual(42);
                });
              });
            });
          });

        });

        describe('Math', function() {
          it('addExact() should add', function() {
            return Java.type('java.lang.Math').then(function(Math) {
              return Math.addExact(3, 7).then(function(result) {
                expect(result).toEqual(10);
              });
            });
          });

          it('random() should return a value', function() {
            return Java.type('java.lang.Math').then(function(Math) {
              return Math.random().then(function(result) {
                expect(result)
                  .toExist()
                  .toBeLessThan(1.0)
                  .toBeGreaterThanOrEqual(0);
              });
            });
          })

          it('final fields should be accessible', function() {
            return Java.type('java.lang.Math').then(function(JMath) {
              return JMath.PI.then(function(result) {
                expect(result)
                  .toBeLessThan(4.0)
                  .toBeGreaterThanOrEqual(3.14);
              });
            });
          })
        });

        if (!isWorkerBased) {
          // Long type not supported in web worker

          describe('System', function() {
            it('currentTimeMillis() should return a timestamp', function() {
              return Java.type('java.lang.System').then(function(System) {
                return System.currentTimeMillis().then(function(result) {
                  expect(result)
                    .toExist()
                    .toBeGreaterThanOrEqual(0);
                });
              });
            });
          });
        }

        describe('classes/Main.class', function() {
          it('instance and private methods should not exist in class wrapper', function() {
            return Java.type('Main').then(function(Main) {
              expect(Main.publicInstanceMethod).toNotExist();
              expect(Main.privateMethod).toNotExist();
              expect(Main.protectedMethod).toNotExist();
              expect(Main.privateInstanceMethod).toNotExist();
              expect(Main.protectedInstanceMethod).toNotExist();
            });
          });

          it('static test()', function() {
            return Java.type('Main').then(function(Main) {
              return Main.test().then(function(result) {
                expect(result).toEqual('test message');
              });
            });
          });

          it('function that flips a boolean value', function() {
            return Java.type('Main').then(function(Main) {
              var trueCheck = Main.flip(true).then(function(result) {
                expect(result).toEqual(false);
              });
              var falseCheck = Main.flip(false).then(function(result) {
                expect(result).toEqual(true);
              });
              return Promise.all([trueCheck, falseCheck]);
            });
          });

          it('function that returns a true value', function() {
            return Java.type('Main').then(function(Main) {
              return Main.checkLength("xyz", 3).then(function(result) {
                expect(result).toEqual(true);
              });
            });
          });

          it('function that returns a false value', function() {
            return Java.type('Main').then(function(Main) {
              return Main.checkLength("xyz", 8).then(function(result) {
                expect(result).toEqual(false);
              });
            });
          });

        });

      });

      describe('dynamically addClass', function(){
        it('add jar', function(){
          return addClass('/jars/commons-codec-1.10.jar').then(function(addClassResult){
            return Java.type('org.apache.commons.codec.binary.StringUtils').then(function(StringUtils) {
              return StringUtils.equals('a','a').then(function (result){
                expect(result).toEqual(true);
              });
            });
          });
        });

        it('add class', function(){
          return addClass('/classes/Main2.class').then(function(addClassResult){
            return Java.type('Main2').then(function(Main) {
              return Main.test().then(function(result) {
                expect(result).toEqual('test message in Main2');
              });
            });
          });
        });

        it('add remote source code', function() {
          return addClass('/classes/Main3.java').then(function(addClassResult){
            return Java.type('com.javapoly.test.Main3').then(function(Main3) {
              return Main3.testIt().then(function(result) {
                expect(result).toEqual('Main3::testIt()');
              });
            });
          });
        });

        it('add embedded source code', function() {
          var mainJavaSource = `package com.javapoly.test;
            public class Main4 {
            public static String testIt() {
              return "Main4:testIt()";
            }
          }`;
          return addClass(mainJavaSource).then(function(addClassResult){
            return Java.type('com.javapoly.test.Main4').then(function(Main4) {
              return Main4.testIt().then(function(result) {
                expect(result).toEqual('Main4:testIt()');
              });
            });
          });
        });

      });

    });

    // TODO: akadeev: checkLeaks() does not work for such complex promises tests
    // There might be a way to fix it
    //mocha.checkLeaks();
    mocha.run();
  </script>
</body>
</html>
